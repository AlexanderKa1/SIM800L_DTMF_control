Система удаленного запуска двигателя автомобиля на базе связки SIM800L + Arduino c управлением по DTMF и отчетами по SMS.
Дозвон до модем с заданного номера, ввод пин кода в тоновом режиме. 

[Скетч для загрузки через Arduino IDE](https://github.com/martinhol221/SIM800L_DTMF_control/blob/master/Autostart_Citroen_V3.1.ino) для загрузки в Arduino Pro Mini (8Mhz/3.3v)

## Как выглядит устройство управление реле
![](https://github.com/martinhol221/SIM800L_DTMF_control/blob/master/img/Arduino%2BSim800l.JPG)

## Как подключается устройство
![](https://github.com/martinhol221/SIM800L_DTMF_control/blob/master/img/autostart.jpg)

# Как это работает прошивка

Ардуино слушает `SoftwareSerial SIM800(7, 6)` получая и отправляя АТ команды от модема и в модем.

Управляет через транзисторы 

* `STARTER_Pin` - дополнительным реле стартера

* `ON_Pin`- дополнительное реле зажигания

* `FIRST_P_Pin` - реле на включение первого положения замка зажигания или обходчика имобилайзера

Замеряет уровни на входах:

* `BAT_Pin` - для замера напряжения АКБ при детектирование момента запуска по напряжению

* `Feedback_Pin` - для проверки на момент включенного зажигания с ключа

* `STOP_Pin` - для проверки нажатой педали тормоза или включенной передачи

* `PSO_Pin` - для в случае детектирования по давлению масла (опция)

* `D2`- для датчиков объема или вибрации (опция)

* `D3` - для подключения к датчику распредвала (опция)

* `L` - на пин 15 K-line шины в OBDII разъёме (опция)

* `K` - на пин 7 K-line шины в OBDII разъёме (опция)


Каждых 10 секунд читает температуру с датчиков DS18B20 обновляя переменные `TempDS0, TempDS1, TempDS2` и моргает светодиодом.



# Какие функции поддерживает

## 1. Входящий звонок.
  
При входящем звонке с номера `call_phone` "снимает трубку" и проигрывает DTMF-гудок, ожидая ввода команды с клавиатуры телефона;

* ввод `123` включает запуск двигателя с 5-ю попытками и на время прогрева в 10 минут
* ввод `456` включает запуск двигателя с 5-ю попытками и на время прогрева в 20 минут
* ввод `789` останавливает таймер и обнуляет его.
* ввод `*`   затирает ошибочно введенные цифры
* ввод `#`   разрывает соединение и отправляет смс на номер `SMS_phone`

## 2. Исходящее СМС сообщение содержит информацию;

`Privet Vasja Pupkin` - имея сенсора задаваемого в шапке скетча

`Temp.Dvig:  42.05`   - температура датчика DS18B20 расположенного на трубках отопителя салона

`Temp.Salon: 24.01`   - температура датчика DS18B20 расположенного в ногах воддителя

`Temp.Ulica: 15.03`   - температура датчика DS18B20 расположенного снаружи автомобиля

`Uptime: 354H`        - время непрерывной работы ардуино в часах

`Vbat: 13.01V`        - напряжение АКБ автомобиля

`Progrev, Timer 8`    - состояние таймера обратного отсчета

`narodmon.ru ON`      - Признак включенной функции отправки данных на [narodmon.ru](narodmon.ru)

`Zahiganie ON`        - Признак включенного зажигания определенное по проводу `Feedback_Pin`

`Popytok: 1`          - Число включения стартера с последнего удачного или неудачного запуска

Номер телефона нужно указывать с плюсом в международном формате.


## 3. Входящие SMS команды

* СМС с текстом `123start14` запустит двигатель на 14 минут. `123` можно заменить на свой секретный трёхзначные пароль в скетче, двузначное число после `start` устанавливает время прогрева. 
* СМС со словом `stop` остановит прогрев


## 4. Отправка показаний датчиков на сервер

Каждые 5 минут открывает GPRS соединение и отправляет пакет вида:
 
`#80-00-00-XX-XX-XX#SensorName`

`#Temp1#42.05`

`#Temp2#24.01`

`#Temp2#15.03`

`#Vbat#13.01`

`#Uptime#7996`

`##`

на сервер `narodmon.ru:8283` 

## 5. Прием команд из приложения Народмон 2017

Команды такие же как и при входящем СМС, отличие в том что команда доходит только в момент связи с сервером от 0 до 5 минут, как повезет.

# Алгоритм запуска: 
После получения команды на запуск из смс или путем набора кода запуска, устройство;

1 Обнуляет счётчик попыток запуска

2 Задаёт время работы стартера в 1.1 сек для первой попытки

3 Изменяем время работы стартера если температура двигателя меньше 15, 5, -5, -10, -15, -30 на значения 1.2, 1.8, 2.2 3.3, 6.0 и 0 сек соответственно своей температуре

4 Проверяем что бы напряжение АКБ было больше 10 вольт, зажигание с ключа не включено (гарантия что двигатель не работает) и число попыток запуска не достигло максимальных (5 попыток).

5 Если предыдущие условие выполненной то включаем реле первого положения замка зажигания , ожидаем 0.5 сек

6 Включаем реле зажигания, ожидаем 4 сек., проверяем не было ли  предыдущих неудачных попыток запуска 
  
  6.1 Eсли их было 2 и более то дополнительно выключаем/включаем зажигание на 2/8сек

  6.2 Если предыдущих неудачных попыток запуска было 4 и более то дополнительно выключаем/включаем зажигание на 10/8сек

7 Включаем реле стартера установленное время ` StTime `  и выключаем его.

8 Выжидаем 6 сек. на набор аккумулятором напряжения заряда от генератора.

9 Заменяем напряжение АКБ, и если измеренное напряжение выше установленного порога в 13.5 то считаем старт успешным, иначе возвращаемся к пункту 4.


# Ближайшие планы по прошивке:

* Сделать автоподъем трубки на 4-й гудок, если гудков было меньше 4х и звонящий абонент положил трубку раньше то запускаем двигатель.

* Сделать управление запуском и обмен данными с машиной из приложения на андроид, по gprs каналу используя протоколу MQTT.

* Допилить чтение температуры и оборотов двигателя по протоколу K-Line шины для авто поддерживающих ISO 14230-4 KWP 10.4 Kbaud.

* Написать функцию обратного дозвона при срабатывании датчика объем для реализации примитивной сигнализации.

* Добавить возможность подключать дешевый сканер отпечатков пальцев для постановки или снятия с охраны

* Добавить возможность подключения GPS-датчика, для реализации тестового треккера

* Перевести управление с ArduinoProMini на ESP8266 с заменой прошивки и возможностью обновления через интернет, или с веб страницы и прочими плюшками. 


